---

# This role was written with OpenBSD in mind, so package names might not be the
# same on other operating systems
#
# This role also assumes you want a single Zabbix server backed by MySQL
# (MariaDB).

- name: install zabbix-server
  package:
      # The double-dash separates the package name from the package flavor.
      # This is an OpenBSD thing
      name: zabbix-server--mysql
      state: present
  tags:
    - monitoring

- name: install zabbix-web
  package:
      name: zabbix-web
      state: present
  tags:
    - monitoring

- name: ensure the zabbix database exists in MySQL
  mysql_db:
      name: zabbix
      state: present
  tags:
    - monitoring

- name: ensure a zabbix user exists in MySQL with correct permissions
  mysql_user:
      name: zabbix
      state: present
      password: "{{ zabbix_database_password }}"
      host: localhost
      priv: zabbix.*:SELECT,INSERT,UPDATE,DELETE,CREATE,DROP,INDEX,ALTER,CREATE TEMPORARY TABLES
  tags:
    - monitoring

- name: check to see if schemas need to be imported
  stat:
      path: "{{ zabbix_schema_status_path }}"
  register: schema_status_file
  tags:
    - monitoring

- name: import Zabbix schemas
  when: schema_status_file.stat.exists == False
  mysql_db:
      state: import
      name: zabbix
      target: "{{ item }}"
  loop:
      - /usr/local/share/zabbix/schema/mysql/schema.sql
      - /usr/local/share/zabbix/schema/mysql/images.sql
      - /usr/local/share/zabbix/schema/mysql/data.sql
  tags:
    - monitoring

- name: create schema check file to preserve idempotence (poorly)
  when: schema_status_file.stat.exists == False
  file:
      state: file
      path: "{{ zabbix_schema_status_path }}"
  tags:
    - monitoring

- name: install httpd.conf to suppot Zabbix
  template:
      src: httpd-zabbix.conf.j2
      dest: /etc/httpd.conf
      validate: /usr/sbin/httpd -nf %s
      backup: yes
      owner: root
      group: wheel
      mode: '0644'
  notify:
    - reload httpd
  tags:
    - monitoring

- name: enable httpd
  service:
      name: httpd
      state: started
      enabled: yes
  tags:
    - monitoring

- name: install pf.conf to support Zabbix
  template:
      src: pf-zabbix.conf.j2
      dest: /etc/pf.conf
      validate: /sbin/pfctl -nf %s
      backup: yes
      owner: root
      group: wheel
      mode: '0600'
  notify:
    - reload pf
  tags:
    - monitoring

- name: install php-7.1.ini to support Zabbix
  template:
      src: php-7.1.ini.j2
      dest: /etc/php-7.1.ini
      owner: root
      group: wheel
      mode: '0644'
  tags:
    - monitoring

- name: link gd, opcache, and zabbix PHP config files into place
  file:
      state: link
      path: /etc/php-7.1/{{ item }}.ini
      src: /etc/php-7.1.sample/{{ item }}.ini
      owner: root
      group: wheel
      mode: '0644'
  loop:
    - gd
    - opcache
    - zabbix
  tags:
    - monitoring

- name: enable and start php71-fpm
  service:
      name: php71-fpm
      enabled: yes
      state: started
  tags:
    - monitoring

- name: enable and start zabbix-server
  service:
      name: zabbix_server
      enabled: yes
      state: started
  tags:
    - monitoring

- name: enable and start zabbix_agentd
  service:
      name: zabbix_agentd
      enabled: yes
      state: started
  tags:
    - monitoring
